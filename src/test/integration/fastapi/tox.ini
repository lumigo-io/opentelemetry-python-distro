[tox]
envlist = py3{11,10,9,8,7,6}
skipsdist = True
skip_missing_interpreters = True

[envlists]
python_runtime = 

[testenv]
recreate = True
deps =
  json-stream
  pytest
  requests
  ../../../../
  fastapi=={env:FASTAPI_VERSION:0.50.0}
  uvicorn=={env:UVICORN_VERSION:0.16.0}
whitelist_externals =
  killall
  rm
  sh
  test
setenv =
  OTEL_SERVICE_NAME = app
  LUMIGO_DEBUG_SPANDUMP = spans.txt


# Startup the test app
commands_pre =
  pip install -U pip
  sh -c "uvicorn app:app &"

# Run tests
commands =
  pytest --tb native --log-cli-level=INFO --color=yes -v {toxinidir}/tests/test_fastapi.py
  rm spans.txt # Spans file is deleted only if tests succeed

commands_post =
  sh -c "./kill_uvicorns.sh"
