[tox]
envlist = py3{11,10,9,8,7,6}
skipsdist = True
skip_missing_interpreters = True

[testenv]
recreate = True
# deps =
allowlist_externals =
  kill
  rm
  sh
  test
setenv =
  OTEL_SERVICE_NAME = app
  LUMIGO_DEBUG_SPANDUMP = spans.txt

# Startup the test app
commands_pre =
  sh -c 'echo "Python3 interpreter: $(which python3)"'
  sh -c 'echo "Python3 version: $(python3 --version)"'
  python -m pip install json-stream pytest==7.1.1 requests==2.27.1 fastapi=={env:FASTAPI_VERSION:0.50.0} uvicorn=={env:UVICORN_VERSION:0.16.0} ../../../../

# Run tests
commands =
  sh -c 'uvicorn app:app --port 8000 &'
  pytest --tb native --log-cli-level=INFO --color=yes -v {toxinidir}/tests/test_fastapi.py
  rm spans.txt # Spans file is deleted only if tests succeed

commands_post =
  sh -c "./kill_uvicorns.sh"
